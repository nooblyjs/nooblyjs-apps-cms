<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Builder - CMS Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- CodeMirror Editor -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="bi bi-pencil-square"></i> CMS Builder
      </a>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" onclick="goBack()">
          <i class="bi bi-arrow-left"></i> Back
        </button>
        <button class="btn btn-outline-warning btn-sm" id="saveBtnTop" onclick="savePage()">
          <i class="bi bi-download"></i> Save
        </button>
        <button class="btn btn-outline-success btn-sm" onclick="publishSite()">
          <i class="bi bi-cloud-upload"></i> Publish
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid h-100" style="padding-top: 1rem;">
    <div class="row h-100">
      <!-- Left Panel: Pages List -->
      <div class="col-md-3 border-end" style="max-height: calc(100vh - 56px); overflow-y: auto;">
        <div class="p-3">
          <h6 class="text-muted mb-3">PAGES</h6>
          <div id="pagesList" class="list-group mb-3">
            <p class="text-muted">Loading...</p>
          </div>
          <button class="btn btn-sm btn-primary w-100" data-bs-toggle="modal" data-bs-target="#newPageModal">
            <i class="bi bi-plus"></i> New Page
          </button>
        </div>
      </div>

      <!-- Main Content: Editor -->
      <div class="col-md-9" style="max-height: calc(100vh - 56px); overflow-y: auto;">
        <div id="editorContainer" class="p-3">
          <div class="card">
            <div class="card-header">
              <div class="row align-items-center">
                <div class="col">
                  <h5 id="pageTitle" class="mb-0">Select a page to edit</h5>
                </div>
                <div class="col-auto">
                  <span id="pageStatus" class="badge bg-secondary">draft</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Page Title</label>
                <input type="text" class="form-control" id="pageTitleInput" placeholder="Page title">
              </div>

              <div class="mb-3">
                <label class="form-label">HTML Content</label>
                <textarea id="htmlEditor"></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Meta Description</label>
                <textarea class="form-control" id="metaDescription" rows="2" placeholder="SEO description"></textarea>
              </div>

              <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="savePage()">
                  <i class="bi bi-check-circle"></i> Save Page
                </button>
                <button class="btn btn-warning" id="previewBtn" onclick="previewPage()" style="display: none;">
                  <i class="bi bi-eye"></i> Preview
                </button>
                <button class="btn btn-danger" onclick="deletePage()" style="display: none;" id="deleteBtn">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Page Modal -->
  <div class="modal fade" id="newPageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Page</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Page Name</label>
            <input type="text" class="form-control" id="newPageName">
          </div>
          <div class="mb-3">
            <label class="form-label">Page Title</label>
            <input type="text" class="form-control" id="newPageTitle">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createPage()">Create</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const siteId = '<%= siteId %>';
    let currentPageId = null;
    let pages = [];
    let editor;

    async function loadPages() {
      try {
        const response = await axios.get(`/api/pages/${siteId}`);
        pages = response.data;
        renderPagesList();
        if (pages.length > 0) {
          loadPage(pages[0].id);
        }
      } catch (error) {
        console.error('Failed to load pages', error);
      }
    }

    function renderPagesList() {
      const pagesList = document.getElementById('pagesList');
      if (pages.length === 0) {
        pagesList.innerHTML = '<p class="text-muted text-center">No pages yet</p>';
        return;
      }

      pagesList.innerHTML = pages.map(page => `
        <a href="#" class="list-group-item list-group-item-action ${currentPageId === page.id ? 'active' : ''}" onclick="loadPage('${page.id}'); return false;">
          <div class="d-flex justify-content-between align-items-center">
            <span>${page.title}</span>
            <span class="badge bg-${page.status === 'published' ? 'success' : 'warning'} ms-2">${page.status}</span>
          </div>
        </a>
      `).join('');
    }

    async function loadPage(pageId) {
      try {
        const response = await axios.get(`/api/pages/${siteId}/${pageId}`);
        const page = response.data;
        currentPageId = pageId;

        document.getElementById('pageTitle').textContent = page.title;
        document.getElementById('pageTitleInput').value = page.title;
        document.getElementById('pageStatus').textContent = page.status;
        document.getElementById('metaDescription').value = page.seo?.description || '';

        // Populate editor
        const htmlContent = page.content?.map(block => {
          if (block.type === 'text') return `<p>${block.content}</p>`;
          if (block.type === 'heading') return `<h${block.level}>${block.content}</h${block.level}>`;
          if (block.type === 'image') return `<img src="${block.src}" alt="${block.alt || ''}" class="img-fluid">`;
          return '';
        }).join('\n') || '<h1>' + page.title + '</h1>\n<p>Start editing your content...</p>';

        editor.setValue(htmlContent);

        document.getElementById('previewBtn').style.display = 'inline-block';
        document.getElementById('deleteBtn').style.display = 'inline-block';

        renderPagesList();
      } catch (error) {
        console.error('Failed to load page', error);
      }
    }

    async function createPage() {
      const name = document.getElementById('newPageName').value;
      const title = document.getElementById('newPageTitle').value;

      if (!name || !title) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const response = await axios.post('/api/pages', {
          siteId,
          name,
          title,
          slug: name.toLowerCase().replace(/\s+/g, '-')
        });

        if (response.data.success) {
          bootstrap.Modal.getInstance(document.getElementById('newPageModal')).hide();
          document.getElementById('newPageName').value = '';
          document.getElementById('newPageTitle').value = '';
          loadPages();
        }
      } catch (error) {
        alert(error.response?.data?.error || 'Failed to create page');
      }
    }

    async function savePage() {
      if (!currentPageId) {
        alert('Please select a page first');
        return;
      }

      const title = document.getElementById('pageTitleInput').value;
      const htmlContent = editor.getValue();
      const metaDescription = document.getElementById('metaDescription').value;

      // Parse HTML content into blocks
      const content = parseHTMLBlocks(htmlContent);

      try {
        const response = await axios.put(`/api/pages/${currentPageId}`, {
          siteId,
          title,
          content,
          seo: { description: metaDescription }
        });

        if (response.data.success) {
          alert('Page saved successfully');
          loadPages();
        }
      } catch (error) {
        alert(error.response?.data?.error || 'Failed to save page');
      }
    }

    function parseHTMLBlocks(html) {
      const blocks = [];
      const div = document.createElement('div');
      div.innerHTML = html;

      Array.from(div.children).forEach(el => {
        if (el.tagName === 'P') {
          blocks.push({ type: 'text', content: el.textContent });
        } else if (['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(el.tagName)) {
          blocks.push({
            type: 'heading',
            level: parseInt(el.tagName[1]),
            content: el.textContent
          });
        } else if (el.tagName === 'IMG') {
          blocks.push({
            type: 'image',
            src: el.src,
            alt: el.alt
          });
        }
      });

      return blocks;
    }

    async function deletePage() {
      if (!currentPageId) return;
      if (!confirm('Are you sure?')) return;

      try {
        const response = await axios.delete(`/api/pages/${currentPageId}`, {
          data: { siteId }
        });

        if (response.data.success) {
          alert('Page deleted');
          loadPages();
        }
      } catch (error) {
        alert(error.response?.data?.error || 'Failed to delete page');
      }
    }

    function previewPage() {
      const htmlContent = editor.getValue();
      const w = window.open();
      w.document.write(htmlContent);
      w.document.close();
    }

    async function publishSite() {
      if (!confirm('Publish this site?')) return;

      try {
        const response = await axios.post(`/api/publish/${siteId}`);
        if (response.data.success) {
          alert('Site published! URL: http://localhost:3000' + response.data.site.url);
        }
      } catch (error) {
        alert(error.response?.data?.error || 'Failed to publish site');
      }
    }

    function goBack() {
      window.location.href = '/sites';
    }

    // Initialize editor
    window.addEventListener('DOMContentLoaded', () => {
      editor = CodeMirror.fromTextArea(document.getElementById('htmlEditor'), {
        lineNumbers: true,
        mode: 'htmlmixed',
        theme: 'dracula',
        indentUnit: 2,
        height: 'auto'
      });

      loadPages();
    });
  </script>
</body>
</html>
